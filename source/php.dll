<?php
function is_connected() {
	exec("mode con:cols=82 lines=30");
	$connected = false;
	$connected = @fopen("http://www.google.com:80/","r");
	if($connected) { return true; }
	else { return false; }
} 
// Ocultar cursor
function hide_cursor() {
    fprintf(STDOUT, "\033[?25l"); // hide cursor
}
function show_cursor() {
    fprintf(STDOUT, "\033[?25h"); //show cursor
}
function truncar($numero, $digitos){
    $truncar = 10**$digitos;
    return intval($numero * $truncar) / $truncar;
}
// *********************** Buscar ***********************
function buscar($a,$b) { if (strstr($a,$b)) return true; else return false; }
// *********************** Colores ***********************
function color() {
	$p = "\e[";
	$f = ";40m";
	$color[0] = $p."0;30".$f; // Negro
	$color[1] = $p."1;30".$f; // Gris oscuro
	$color[2] = $p."0;31".$f; // Rojo
	$color[3] = $p."1;31".$f; // Rojo Claro
	$color[4] = $p."0;32".$f; // Verde
	$color[5] = $p."1;32".$f; // Verde Claro
	$color[6] = $p."0;33".$f; // Marron
	$color[7] = $p."1;33".$f; // Marillo
	$color[8] = $p."0;34".$f; // Azul
	$color[9] = $p."1;34".$f; // Azul Claro
	$color[10] = $p."0;35".$f; // Magenta
	$color[11] = $p."1;35".$f; // Magenta Claro
	$color[12] = $p."0;36".$f; // Cyan 
	$color[13] = $p."1;36".$f; // Cyan Claro
	$color[14] = $p."0;37".$f; // Gris claro
	$color[15] = $p."1;37".$f; // Blanco
	return $color;
}
// Decode
function d64($str,$v) {
	for($n=0;$n<$v;$n++) {
		$str = base64_decode($str);
	}
	return $str;
}
// *********************** Limpiar pantalla ***********************
function clear() {
	echo chr(27).chr(91).'H'.chr(27).chr(91).'J';
}
// *********************** Check si existe ruta y entrar *********************** 
function check($path) {
	$color = color();
	if (file_exists($path)) {
		chdir($path);
	}else {
		echo $color[2]."I: ".$color[14]."El programa podría no funcionar correctamente ya que la ruta del sistema no existe.\n";
	}
	return $path;
}
// *********************** Check si existe de PF y entrar *********************** 
function checkPF() {
	$ProgramFiles = "C:\Program Files";
	$ProgramFiles86 = "C:\Program Files (x86)";
	$Office16 = "\Microsoft Office\Office16\\";
	$Ospp = "ospp.vbs";
	if (file_exists($ProgramFiles.$Office16.$Ospp)) { $PF = $ProgramFiles; }
	else if (file_exists($ProgramFiles86.$Office16.$Ospp)) { $PF = $ProgramFiles86; }
	chdir($PF.$Office16);
	return $PF;
}
// *********************** PARAMETROS *********************** 
// Comprobar licencias
function licenses($PF){
	$Licenses16 = "\Microsoft Office\\root\Licenses16\\";
	if ($handle = opendir($PF.$Licenses16)) {
		$n = 0;
		while (false !== ($file = readdir($handle))) {
			if ($file != "." && $file != ".." && trim(substr($file, 0, 13))=="ProPlus2019VL" && trim(substr($file, 0, 13))){
				exec('cscript ospp.vbs /inslic:"'.$PF.$Licenses16.$file.'"  1>null');
			}
		}
		closedir($handle);
	}
}
// Borrar servicio de administración de claves
function param1($color) {
	$i = "\n";
	exec("cscript //nologo slmgr.vbs /ckms",$r);
	if (buscar($r[0], "El nombre de equipo del Servicio de administra") && buscar($r[0],"correctamente")) { 
		echo $color[12]."I: ".$color[14]."Se reinició el servicio de administración de claves.".$i;
	}else {
		echo $color[4]."I: ".$color[14]."Ocurrió un error al reiniciar el servicio de administración de claves.".$i;
	}
}
// Aplicar configuración
function param2($color) {
	$i = "\n";
	checkPF();
	exec("cscript //nologo ospp.vbs /setprt:1688",$r);
	if (buscar($r[0], "Processing") && buscar($r[2],"Successfully applied setting")) { 
		echo $color[12]."I: ".$color[14]."Configuración aplicada con éxito.".$i;
	}else {
		echo $color[4]."I: ".$color[14]."Ocurrió un error al aplicar la configuración.".$i;
	}
}
// Desinstalando clave del producto
function param3($color) {
	$i = "\n";
	checkPF();
	exec("cscript //nologo ospp.vbs /unpkey:6MWKP",$r);
	if (buscar($r[2], "Uninstalling product key") && buscar($r[3],"Product key uninstall successful")) { 
		echo $color[12]."I: ".$color[14]."Desinstalada clave de producto antigua.".$i;
	}else {
		echo $color[8]."I: ".$color[14]."No se encontró una licencia anterior activa.".$i;
	}
}
// Instalando licencias de producto
function param4($color) {
	$xci = "/100%)";
	$ky = array("Tk1NS0otNlJLNEYtS01KVlgtOEQ5TUotNk1XS1A", "Professional Plus 2019",
				 "Nk5XV0otWVFXTVItUUtHQ0ItNlRNQjMtOUQ5SEs", "Standard 2019",
				 "QjROUFItM0ZLSzctVDJNQlYtRlJRNFctUEtEMkI", "Project Professional 2019",
				 "QzRGN1AtTkNQOEMtNkNRUFQtTVFIVjktSlhEMk0", "Project Standard 2019",
				 "OUJHTlEtSzM3WVItUlFIRjItMzhSUTMtN1ZDQkI", "Visio Professional 2019",
				 "N1RRTlEtSzNZUVEtM1BGSDctQ0NQUE0tWDRWUTI", "Visio Standard 2019",
				 "OU45UFQtMjdWNFktVkoyUEQtWVhGTUYtWVRGUVQ", "Access 2019",
				 "VE1KV1QtWVlOTUItM0JLVEYtNjQ0RkMtUlZYQkQ", "Excel 2019",
				 "N0hEN0stTjRQVkstQkhCQ1EtWVdRUlctWFc0Vks", "Outlook 2019",
				 "UlJOQ1gtQzY0SFktVzJNTTctTUNIOUctVEpITVE", "PowerPoint 2019",
				 "RzJLV1gtM05XNlAtUFk5M1ItSlhLMlQtQzlZOVY", "Publisher 2019",
				 "TkNKMzMtSkhCQlktSFRLOTgtTVlDVjgtSE1LSEo", "Skype for Business 2019",
				 "UEJYM0ctTldNVDYtUTdYQlctUFlKR0ctV1hEMzM", "Word 2019"
	);
	$i = "\n";
	checkPF();
	$total = count($ky);
	$tu = truncar(100/($total/2), 0);
	$ctx = 1;
	for($nx=0;$nx<$total;$nx++){
		exec("cscript //nologo ospp.vbs /inpkey:".d64($ky[$nx], 1), $r);
		$porciento = ($tu+1) * $ctx;
		$nx++;
		$ctx++;
		if (100 > $porciento) {
			echo "\n";
			echo "\033[1A";
			echo $color[12]."I: ".$color[14]."Instalando licencias.. (".$porciento.$xci;
		}else if (100 <= $porciento) {
			echo "\n";
			echo "\033[1A";
			echo $color[12]."I: ".$color[14]."Instalando licencias.. (100".$xci;
		}
	}
	echo $i;
}
// Comprobar licencias
function getApp($str) {
		$ky = array("Tk1NS0otNlJLNEYtS01KVlgtOEQ5TUotNk1XS1A", "Office Professional Plus 2019",
				 "Nk5XV0otWVFXTVItUUtHQ0ItNlRNQjMtOUQ5SEs", "Office Standard 2019",
				 "QjROUFItM0ZLSzctVDJNQlYtRlJRNFctUEtEMkI", "Project Professional 2019",
				 "QzRGN1AtTkNQOEMtNkNRUFQtTVFIVjktSlhEMk0", "Project Standard 2019",
				 "OUJHTlEtSzM3WVItUlFIRjItMzhSUTMtN1ZDQkI", "Visio Professional 2019",
				 "N1RRTlEtSzNZUVEtM1BGSDctQ0NQUE0tWDRWUTI", "Visio Standard 2019",
				 "OU45UFQtMjdWNFktVkoyUEQtWVhGTUYtWVRGUVQ", "Access 2019",
				 "VE1KV1QtWVlOTUItM0JLVEYtNjQ0RkMtUlZYQkQ", "Excel 2019",
				 "N0hEN0stTjRQVkstQkhCQ1EtWVdRUlctWFc0Vks", "Outlook 2019",
				 "UlJOQ1gtQzY0SFktVzJNTTctTUNIOUctVEpITVE", "PowerPoint 2019",
				 "RzJLV1gtM05XNlAtUFk5M1ItSlhLMlQtQzlZOVY", "Publisher 2019",
				 "TkNKMzMtSkhCQlktSFRLOTgtTVlDVjgtSE1LSEo", "Skype for Business 2019",
				 "UEJYM0ctTldNVDYtUTdYQlctUFlKR0ctV1hEMzM", "Word 2019"
	);
	$rest = substr($str, -5);
	$total = count($ky);
	for($nx=0;$nx<$total;$nx++){
		$ty = substr(d64($ky[$nx], 1), -5);
		$nx++;
		if ($rest==$ty) { return $ky[$nx]; }
	}
	return "la aplicación";
	
}
function param5($color) {
	$i = "\n";
	echo $color[12]."I: ".$color[14]."Conectando con el servicio de licencias..".$i;
	checkPF();
	exec("cscript //nologo ospp.vbs /act",$r);
	$total = count($r);
	for($nx=0;$nx<$total;$nx++) {
		if (buscar($r[$nx], "Last 5 characters of installed product key")) {
			$app = getApp($r[$nx]);
			$nx++;
			if (buscar($r[$nx], "Product activation successful")) { echo $color[12]."I: ".$color[14]."La licencia de ".$app." ha sido activada correctamente.".$i; }
		}
	}
	$i;
}
// Cuenta atras
function countdown($seconds) { 
	$color = color();
	for ($i = $seconds; $i >= 1; $i--) {
		if ($i>3) { $cc = $color[7]; }
		else if ($i<=3) { $cc = $color[13]; }
		echo $color[12]."I: ".$color[14]."La ventana se cerrará en ".$cc.$i.$color[14]." segundos..\n";
		sleep(1);
		echo "\033[1A";
	}
}
/************************** VARIABLES *************************************/
clear();
$color = color();
header("content-type: text/html; charset=UTF-8"); 
$sys = "C:\Windows\System32\\";
$i = "\n";
/************************** INICIO *******************************/
hide_cursor();
$internet = is_connected();
if (!$internet) { 
	prin("No se detectó conexión a Intentet.\n", 3);
	sleep(3);
	exit;
}
echo $color[12]."============================== Productos soportados ==============================$i";
echo $i;
echo $color[7]." - ".$color[14]."Microsoft Office Standard 2019$i";
echo $color[7]." - ".$color[14]."Microsoft Office Professional Plus 2019$i";
echo $i;
echo $color[12]."==================================================================================$i";
echo $i;
echo $color[12]."I: ".$color[14]."Comenzando activación de Office 2019..".$i;
echo $color[12]."I: ".$color[14]."Realizando algunas comprobaciones..".$i;
$PF = checkPF(); // Meterme en ruta de office
licenses($PF); // Comprobar licencias

$str = strlen(check($sys)); // Meterme en system
if ($str >= 0) {
	param1($color); // Borrar servicio de administración de claves
	param2($color); // Aplicar configuración
	param3($color); // Desinstalando clave del producto
	param4($color); // Instalando nueva clave del producto
	param5($color); // Conectando con el servidor de claves
	echo $i.$i;
}
// Cuenta atrás para finalizar programa de activacion
countdown(10);
show_cursor()
?>